// Prisma Schema voor DAAR Kennisbank & Blog
// Database: Neon PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ARTIKELEN & KENNISBANK
// ============================================

model Article {
  id              String         @id @default(cuid())
  title           String
  slug            String         @unique
  content         String         @db.Text  // Rich HTML content
  contentPlain    String         @db.Text  // Plain text voor zoeken/AI
  excerpt         String?        @db.VarChar(500)

  // SEO
  metaTitle       String?        @db.VarChar(60)
  metaDescription String?        @db.VarChar(160)
  canonicalUrl    String?

  // Media
  featuredImage    String?
  featuredImageAlt String?
  headerStyle      String         @default("gradient-green") // "image" | "gradient-green" | "gradient-yellow" | "gradient-coral" | "gradient-blue" | "gradient-teal" | "gradient-navy"

  // Publishing
  status          ArticleStatus  @default(DRAFT)
  publishedAt     DateTime?

  // Author
  authorId        String
  author          Author         @relation(fields: [authorId], references: [id])

  // Organisatie
  categoryId      String?
  category        Category?      @relation(fields: [categoryId], references: [id])
  tags            TagsOnArticles[]

  // Analytics
  viewCount       Int            @default(0)
  readingTime     Int?           // Minuten

  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relaties
  pageViews       PageView[]
  chatReferences  ChatMessageArticle[]
  researchSources ArticleResearchSource[]

  @@index([slug])
  @@index([status])
  @@index([categoryId])
  @@index([publishedAt])
  @@index([authorId])
}

enum ArticleStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
}

model Category {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?
  icon        String?   // Lucide icon naam
  color       String?   // Hex kleur
  sortOrder   Int       @default(0)

  // Parent categorie voor nesting
  parentId    String?
  parent      Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")

  articles    Article[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([slug])
  @@index([parentId])
}

model Tag {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique

  articles    TagsOnArticles[]

  createdAt   DateTime  @default(now())

  @@index([slug])
}

model TagsOnArticles {
  article     Article   @relation(fields: [articleId], references: [id], onDelete: Cascade)
  articleId   String
  tag         Tag       @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagId       String

  assignedAt  DateTime  @default(now())

  @@id([articleId, tagId])
}

model Author {
  id          String    @id @default(cuid())
  name        String
  email       String    @unique
  bio         String?   @db.Text
  avatar      String?
  role        String?   // "Founder", "Content Writer"

  // Link naar auth user
  userId      String?   @unique
  user        User?     @relation(fields: [userId], references: [id])

  articles    Article[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([email])
}

// ============================================
// AUTHENTICATIE & USERS (NextAuth.js)
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  role          UserRole  @default(VIEWER)
  passwordHash  String?   // Bcrypt hashed password

  // NextAuth
  emailVerified DateTime?
  accounts      Account[]
  sessions      Session[]

  // Relaties
  author        Author?
  teamMember    TeamMember?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
}

enum UserRole {
  VIEWER
  WRITER
  EDITOR
  ADMIN
}

// NextAuth.js vereiste models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// AI CHAT SYSTEEM
// ============================================

model ChatSession {
  id            String        @id @default(cuid())
  visitorId     String        // Anonieme bezoeker identifier

  // Bezoeker tracking
  userAgent     String?
  referrer      String?
  landingPage   String?

  // Lead info (progressief verzameld)
  leadId        String?       @unique
  lead          Lead?         @relation(fields: [leadId], references: [id])

  // Session state
  isActive      Boolean       @default(true)
  lastMessageAt DateTime?
  messageCount  Int           @default(0)

  // Messages
  messages      ChatMessage[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([visitorId])
  @@index([createdAt])
  @@index([isActive])
}

model ChatMessage {
  id            String        @id @default(cuid())
  sessionId     String
  session       ChatSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  role          MessageRole
  content       String        @db.Text

  // Voor assistant messages
  tokensUsed    Int?
  modelUsed     String?

  // Artikel suggesties
  articleRefs   ChatMessageArticle[]

  createdAt     DateTime      @default(now())

  @@index([sessionId])
  @@index([createdAt])
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

// Many-to-many voor gesuggereerde artikelen in chat
model ChatMessageArticle {
  message       ChatMessage   @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId     String
  article       Article       @relation(fields: [articleId], references: [id], onDelete: Cascade)
  articleId     String

  relevanceScore Float?       // Semantic similarity score

  @@id([messageId, articleId])
}

model Lead {
  id            String        @id @default(cuid())

  // Contact info
  name          String?
  email         String?
  phone         String?
  organization  String?

  // Context
  source        LeadSource    @default(CHAT)
  interest      String?       // Waar ze interesse in hebben
  notes         String?       @db.Text

  // Status
  status        LeadStatus    @default(NEW)

  // Relaties
  chatSession   ChatSession?
  bookings      Booking[]
  quizResults   QuizResult[]
  customer      Customer?     // Link naar CRM Customer

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([email])
  @@index([status])
  @@index([createdAt])
}

enum LeadSource {
  CHAT
  CONTACT_FORM
  NEWSLETTER
  DEMO_REQUEST
  QUIZ
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  ARCHIVED
}

// ============================================
// ANALYTICS
// ============================================

model PageView {
  id            String        @id @default(cuid())

  // Wat werd bekeken
  articleId     String?
  article       Article?      @relation(fields: [articleId], references: [id], onDelete: SetNull)
  path          String

  // Bezoeker
  visitorId     String
  sessionId     String?

  // Context
  referrer      String?
  userAgent     String?
  deviceType    DeviceType?

  // Engagement
  timeOnPage    Int?          // Seconden
  scrollDepth   Int?          // Percentage

  createdAt     DateTime      @default(now())

  @@index([articleId])
  @@index([path])
  @@index([createdAt])
  @@index([visitorId])
}

enum DeviceType {
  DESKTOP
  MOBILE
  TABLET
}

// ============================================
// SEARCH QUERIES TRACKING
// ============================================

model SearchQuery {
  id            String        @id @default(cuid())
  query         String
  resultsCount  Int           @default(0)
  visitorId     String?

  createdAt     DateTime      @default(now())

  @@index([query])
  @@index([createdAt])
}

// ============================================
// AFSPRAKEN SYSTEEM
// ============================================

model BookingType {
  id            String        @id @default(cuid())
  slug          String        @unique
  name          String
  description   String?
  duration      Int           // Minuten
  price         String?       // "Gratis", "€150", etc.
  color         String?       // Hex kleur voor kalender

  // Beschikbaarheid
  isActive      Boolean       @default(true)

  // Google Calendar
  calendarId    String?       // Specifieke calendar voor dit type

  bookings      Booking[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([slug])
  @@index([isActive])
}

model Booking {
  id            String        @id @default(cuid())

  // Type afspraak
  bookingTypeId String
  bookingType   BookingType   @relation(fields: [bookingTypeId], references: [id])

  // Wanneer
  startTime     DateTime
  endTime       DateTime
  timezone      String        @default("Europe/Amsterdam")

  // Wie
  name          String
  email         String
  phone         String?
  organization  String?

  // Context
  notes         String?       @db.Text
  source        BookingSource @default(WEBSITE)

  // Status
  status        BookingStatus @default(PENDING)

  // Google Calendar
  calendarEventId String?     // ID van event in Google Calendar
  meetingLink   String?       // Zoom/Meet link

  // Lead koppeling
  leadId        String?
  lead          Lead?         @relation(fields: [leadId], references: [id])

  // CRM Customer koppeling
  customerId    String?
  customer      Customer?     @relation(fields: [customerId], references: [id])

  // Email tracking
  confirmationSent Boolean    @default(false)
  reminderSent     Boolean    @default(false)

  // Cancellation
  cancelledAt   DateTime?
  cancelReason  String?

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([bookingTypeId])
  @@index([startTime])
  @@index([email])
  @@index([status])
  @@index([leadId])
  @@index([customerId])
}

enum BookingSource {
  WEBSITE
  CHAT
  PHONE
  EMAIL
  ADMIN
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

// Business hours configuratie
model BusinessHours {
  id            String        @id @default(cuid())
  dayOfWeek     Int           // 0=zondag, 1=maandag, etc.
  startTime     String        // "09:00"
  endTime       String        // "17:00"
  isActive      Boolean       @default(true)

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@unique([dayOfWeek])
}

// ============================================
// VRIJWILLIGERSCHECK QUIZ
// ============================================

model QuizResult {
  id            String        @id @default(cuid())

  // Scores
  totalScore    Int           // Totaal percentage (0-100)
  dimensionScores Json        // { beheer: 75, communicatie: 60, ... }
  answers       Json          // { "org-size": 2, "beheer-systeem": 3, ... }

  // Profiel
  profileId     String        // kampioen, gevorderd, groei, start

  // Context
  organizationSize String?    // xs, sm, md, lg
  volunteerCount   Int?

  // ROI berekening
  roiData       Json?         // { hoursSaved, costSaved, ... }

  // Bezoeker
  visitorId     String?

  // Lead koppeling
  leadId        String?
  lead          Lead?         @relation(fields: [leadId], references: [id])

  // CRM Customer koppeling
  customerId    String?
  customer      Customer?     @relation(fields: [customerId], references: [id])

  // PDF rapport
  pdfUrl        String?

  // Sharing
  shareToken    String        @unique @default(cuid())

  createdAt     DateTime      @default(now())

  @@index([visitorId])
  @@index([profileId])
  @@index([shareToken])
  @@index([createdAt])
  @@index([customerId])
}

// ============================================
// ONDERZOEK & RAG SYSTEEM
// ============================================

model ResearchSource {
  id            String              @id @default(cuid())

  // Identificatie
  title         String              // Titel van het onderzoek
  slug          String              @unique
  filename      String              // Originele bestandsnaam

  // Metadata
  authors       String?             // Auteurs/onderzoekers
  publisher     String?             // Uitgever/instituut
  publishYear   Int?                // Jaar van publicatie
  sourceUrl     String?             // Originele URL indien beschikbaar

  // Categorisatie
  category      ResearchCategory
  topics        String[]            // Array van onderwerpen

  // Content
  summary       String?             @db.Text  // AI-gegenereerde samenvatting
  keyFindings   Json?               // Array van belangrijkste bevindingen
  methodology   String?             // Onderzoeksmethode
  sampleSize    String?             // Steekproefgrootte

  // Processing status
  status        ResearchStatus      @default(PENDING)
  processedAt   DateTime?

  // Relaties
  chunks        KnowledgeChunk[]
  articles      ArticleResearchSource[]

  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@index([slug])
  @@index([category])
  @@index([status])
}

enum ResearchCategory {
  RETENTIE              // Vrijwilligersretentie & motivatie
  WERVING               // Werving & onboarding
  IMPACT                // Impact meten & rapportage
  TECHNOLOGIE           // AI/ML & digitalisering
  MANAGEMENT            // Organisatie & coördinatie
  WELZIJN               // Welzijn & waardering
  COMPLIANCE            // Juridisch & AVG
}

enum ResearchStatus {
  PENDING               // Nog niet verwerkt
  PROCESSING            // Wordt verwerkt
  COMPLETED             // Volledig verwerkt
  FAILED                // Verwerking mislukt
}

model KnowledgeChunk {
  id              String          @id @default(cuid())

  // Bron
  sourceId        String
  source          ResearchSource  @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  // Content
  content         String          @db.Text    // De tekst chunk
  contentType     ChunkType       @default(PARAGRAPH)

  // Positie in document
  pageNumber      Int?
  chunkIndex      Int             // Volgorde binnen document

  // Metadata voor retrieval
  topics          String[]        // Onderwerpen in deze chunk
  entities        String[]        // Genoemde entiteiten (organisaties, tools, etc.)

  // Vector embedding (stored as JSON, actual vector ops via raw SQL with pgvector)
  // Na pgvector extensie activeren: embedding Vector(1536)
  embeddingJson   Json?           // Tijdelijke opslag als JSON array

  // Kwaliteit & relevantie
  qualityScore    Float?          // AI-beoordeelde kwaliteit (0-1)
  isKeyInsight    Boolean         @default(false)  // Markering voor belangrijke inzichten

  createdAt       DateTime        @default(now())

  @@index([sourceId])
  @@index([contentType])
  @@index([isKeyInsight])
}

enum ChunkType {
  TITLE
  ABSTRACT
  HEADING
  PARAGRAPH
  BULLET_POINT
  STATISTIC       // Cijfers en statistieken
  QUOTE           // Citaten
  CONCLUSION
  RECOMMENDATION
}

// Koppeling tussen artikelen en onderzoeksbronnen
model ArticleResearchSource {
  article         Article         @relation(fields: [articleId], references: [id], onDelete: Cascade)
  articleId       String
  source          ResearchSource  @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  sourceId        String

  // Hoe is de bron gebruikt
  usageType       SourceUsageType @default(REFERENCE)
  citationText    String?         // Specifieke citatie indien van toepassing

  assignedAt      DateTime        @default(now())

  @@id([articleId, sourceId])
}

enum SourceUsageType {
  PRIMARY         // Hoofdbron voor artikel
  REFERENCE       // Ter ondersteuning geciteerd
  STATISTIC       // Statistiek overgenomen
  QUOTE           // Directe quote gebruikt
}

// ============================================
// CRM SYSTEEM
// ============================================

model TeamMember {
  id          String    @id @default(cuid())
  name        String                    // Vincent, Saveim, Thijs
  email       String    @unique
  phone       String?
  role        String?                   // Sales, Account Manager, etc.
  avatar      String?
  color       String    @default("#3BA273") // Voor kalender/UI
  isActive    Boolean   @default(true)

  // Link naar User voor auth
  userId      String?   @unique
  user        User?     @relation(fields: [userId], references: [id])

  // CRM Relaties
  customers         Customer[]
  activities        Activity[]
  tasksAssigned     Task[]      @relation("TaskAssignee")
  tasksCreated      Task[]      @relation("TaskCreator")
  deals             Deal[]
  notes             Note[]

  // Drive relaties
  filesUploaded     DriveFile[]
  foldersCreated    DriveFolder[] @relation("FolderCreator")

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([email])
  @@index([isActive])
}

model Customer {
  id              String          @id @default(cuid())

  // Basis bedrijfsinfo
  companyName     String
  kvkNumber       String?                   // KVK nummer (8 cijfers)
  vatNumber       String?                   // BTW nummer
  website         String?
  industry        String?                   // Branche

  // Daar-specifiek: Vrijwilligersorganisatie info
  organizationType  OrganizationType?       // Stichting, Vereniging, etc.
  sector            OrganizationSector?     // Zorg, Welzijn, Sport, etc.
  volunteerCount    Int?                    // Aantal vrijwilligers
  paidStaffCount    Int?                    // Aantal betaalde medewerkers
  currentSoftware   String?                 // Huidige software voor vrijwilligersbeheer
  painPoints        String?       @db.Text  // Belangrijkste uitdagingen
  desiredFeatures   String?       @db.Text  // Gewenste functionaliteiten
  annualBudget      Decimal?      @db.Decimal(10, 2)  // Jaarbudget organisatie
  subsidized        Boolean       @default(false)     // Ontvangt subsidie
  subsidySource     String?                 // Bron van subsidie (gemeente, etc.)

  // Hoofdcontact
  contactName     String?
  contactEmail    String?
  contactPhone    String?
  contactRole     String?                   // Functie

  // Adres
  address         String?
  postalCode      String?
  city            String?
  country         String          @default("Nederland")

  // CRM Status
  status          CustomerStatus  @default(LEAD)
  source          CustomerSource  @default(WEBSITE)
  employeeCount   String?                   // Grootte organisatie (legacy, use paidStaffCount)

  // Financieel / Prijsafspraken
  priceAgreement  String?         @db.Text  // Beschrijving prijsafspraak
  hourlyRate      Decimal?        @db.Decimal(10, 2)
  monthlyBudget   Decimal?        @db.Decimal(10, 2)
  paymentTerms    Int             @default(30)  // Betalingstermijn in dagen
  currency        String          @default("EUR")

  // Toewijzing
  assignedToId    String?
  assignedTo      TeamMember?     @relation(fields: [assignedToId], references: [id])

  // Follow-up tracking
  lastContactAt   DateTime?
  nextFollowUp    DateTime?

  // Link naar oude Lead (migratie)
  leadId          String?         @unique
  lead            Lead?           @relation(fields: [leadId], references: [id])

  // Relaties
  activities      Activity[]
  tasks           Task[]
  deals           Deal[]
  notes           Note[]
  folders         DriveFolder[]
  quizResults     QuizResult[]
  bookings        Booking[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([assignedToId])
  @@index([status])
  @@index([nextFollowUp])
  @@index([companyName])
  @@index([kvkNumber])
}

enum CustomerStatus {
  LEAD              // Nieuwe lead
  PROSPECT          // Gekwalificeerde prospect
  NEGOTIATION       // In onderhandeling
  CUSTOMER          // Actieve klant
  CHURNED           // Verloren klant
  INACTIVE          // Inactief
}

enum CustomerSource {
  WEBSITE           // Via website
  REFERRAL          // Doorverwijzing
  LINKEDIN          // LinkedIn
  COLD_CALL         // Cold call
  EVENT             // Event/beurs
  PARTNER           // Partner
  CHAT              // Chat widget
  QUIZ              // Via VrijwilligersCheck quiz
  DEMO_REQUEST      // Demo aanvraag
  OTHER             // Overig
}

enum OrganizationType {
  STICHTING         // Stichting
  VERENIGING        // Vereniging
  GOED_DOEL         // Goed doel / Charity
  GEMEENTE          // Gemeente
  ZORGINSTELLING    // Zorginstelling
  WELZIJNSORG       // Welzijnsorganisatie
  COOPERATIE        // Coöperatie
  KERK              // Kerkelijke organisatie
  SPORTCLUB         // Sportvereniging
  BUURTVERENIGING   // Buurt- of wijkvereniging
  OVERIG            // Overig
}

enum OrganizationSector {
  ZORG              // Zorg & Gezondheid
  WELZIJN           // Welzijn & Maatschappelijk werk
  SPORT             // Sport & Recreatie
  CULTUUR           // Cultuur & Kunst
  ONDERWIJS         // Onderwijs & Educatie
  NATUUR            // Natuur & Milieu
  DIEREN            // Dierenwelzijn
  NOODHULP          // Noodhulp & Rampenbestrijding
  OUDEREN           // Ouderenzorg
  JEUGD             // Jeugd & Jongeren
  RELIGIE           // Religieus & Levensbeschouwelijk
  INTERNATIONAAL    // Internationale hulp
  BUURT             // Buurt & Wijk
  OVERIG            // Overig
}

model Activity {
  id              String        @id @default(cuid())
  type            ActivityType
  title           String
  description     String?       @db.Text

  // Wanneer & hoe lang
  occurredAt      DateTime      @default(now())
  duration        Int?                      // Minuten

  // Relaties
  customerId      String
  customer        Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)

  performedById   String
  performedBy     TeamMember    @relation(fields: [performedById], references: [id])

  // Extra metadata (JSON voor flexibiliteit)
  metadata        Json?                     // { emailSubject, callOutcome, meetingType, etc. }

  createdAt       DateTime      @default(now())

  @@index([customerId])
  @@index([performedById])
  @@index([occurredAt])
  @@index([type])
}

enum ActivityType {
  CALL              // Telefoongesprek
  EMAIL_SENT        // Email verstuurd
  EMAIL_RECEIVED    // Email ontvangen
  MEETING           // Vergadering
  VIDEO_CALL        // Video call
  NOTE              // Notitie toegevoegd
  DEMO              // Demo gegeven
  PROPOSAL          // Offerte verstuurd
  FOLLOW_UP         // Vervolgactie
  STATUS_CHANGE     // Status wijziging
  OTHER             // Overig
  DEAL_UPDATE       // Deal update
  LINKEDIN          // LinkedIn interactie
  WHATSAPP          // WhatsApp bericht
}

model Task {
  id              String        @id @default(cuid())
  title           String
  description     String?       @db.Text

  // Status & prioriteit
  status          TaskStatus    @default(TODO)
  priority        TaskPriority  @default(MEDIUM)

  // Timing
  dueDate         DateTime?
  reminderAt      DateTime?
  completedAt     DateTime?

  // Relaties
  customerId      String?
  customer        Customer?     @relation(fields: [customerId], references: [id], onDelete: SetNull)

  assignedToId    String
  assignedTo      TeamMember    @relation("TaskAssignee", fields: [assignedToId], references: [id])

  createdById     String
  createdBy       TeamMember    @relation("TaskCreator", fields: [createdById], references: [id])

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([assignedToId])
  @@index([customerId])
  @@index([dueDate])
  @@index([status])
  @@index([priority])
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  WAITING           // Wachtend op klant/collega
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Deal {
  id                  String      @id @default(cuid())
  name                String
  description         String?     @db.Text

  // Waarde
  value               Decimal?    @db.Decimal(12, 2)
  currency            String      @default("EUR")

  // Pipeline
  stage               DealStage   @default(QUALIFICATION)
  probability         Int         @default(10)        // Percentage kans

  // Timing
  expectedCloseDate   DateTime?
  actualCloseDate     DateTime?

  // Relaties
  customerId          String
  customer            Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)

  ownerId             String
  owner               TeamMember  @relation(fields: [ownerId], references: [id])

  // Win/Loss tracking
  lostReason          String?
  wonReason           String?
  competitorName      String?               // Bij verlies: aan wie verloren?

  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  @@index([customerId])
  @@index([ownerId])
  @@index([stage])
  @@index([expectedCloseDate])
}

enum DealStage {
  QUALIFICATION       // 10% - Eerste contact
  NEEDS_ANALYSIS      // 25% - Behoefteanalyse
  PROPOSAL            // 50% - Offerte fase
  NEGOTIATION         // 75% - Onderhandeling
  CLOSED_WON          // 100% - Gewonnen
  CLOSED_LOST         // 0% - Verloren
}

model Note {
  id          String      @id @default(cuid())
  content     String      @db.Text
  isPinned    Boolean     @default(false)

  // Relaties
  customerId  String
  customer    Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)

  authorId    String
  author      TeamMember  @relation(fields: [authorId], references: [id])

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([customerId])
  @@index([authorId])
  @@index([isPinned])
}

// ============================================
// DRIVE / DOCUMENTEN SYSTEEM
// ============================================

model DriveFolder {
  id              String        @id @default(cuid())
  name            String
  color           String?                   // Kleur voor UI
  icon            String?                   // Lucide icon naam

  // Hiërarchie
  parentId        String?
  parent          DriveFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children        DriveFolder[] @relation("FolderHierarchy")

  // Optioneel gekoppeld aan klant
  customerId      String?
  customer        Customer?     @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // Wie heeft aangemaakt
  createdById     String
  createdBy       TeamMember    @relation("FolderCreator", fields: [createdById], references: [id])

  // Bestanden in deze map
  files           DriveFile[]

  // Sharing
  isShared        Boolean       @default(false)
  shareToken      String?       @unique

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([parentId])
  @@index([customerId])
  @@index([createdById])
  @@index([name])
}

model DriveFile {
  id              String        @id @default(cuid())
  name            String                    // Originele bestandsnaam
  displayName     String?                   // Weergavenaam (optioneel)

  // File info
  mimeType        String
  size            Int                       // Bytes
  extension       String?                   // .pdf, .docx, etc.

  // Storage
  url             String                    // Vercel Blob URL
  blobPathname    String?                   // Blob pathname voor beheer
  thumbnailUrl    String?                   // Preview thumbnail

  // Organisatie
  folderId        String?
  folder          DriveFolder?  @relation(fields: [folderId], references: [id], onDelete: SetNull)

  // Metadata
  description     String?
  tags            String[]                  // Tags voor zoeken

  // Upload info
  uploadedById    String
  uploadedBy      TeamMember    @relation(fields: [uploadedById], references: [id])

  // Versioning (simpel)
  version         Int           @default(1)
  previousVersionId String?

  // Sharing
  isShared        Boolean       @default(false)
  shareToken      String?       @unique
  shareExpiresAt  DateTime?

  // Tracking
  downloadCount   Int           @default(0)
  lastAccessedAt  DateTime?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([folderId])
  @@index([uploadedById])
  @@index([mimeType])
  @@index([name])
  @@index([tags])
}

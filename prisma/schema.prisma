// Prisma Schema voor DAAR Kennisbank & Blog
// Database: Neon PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ARTIKELEN & KENNISBANK
// ============================================

model Article {
  id              String         @id @default(cuid())
  title           String
  slug            String         @unique
  content         String         @db.Text  // Rich HTML content
  contentPlain    String         @db.Text  // Plain text voor zoeken/AI
  excerpt         String?        @db.VarChar(500)

  // SEO
  metaTitle       String?        @db.VarChar(60)
  metaDescription String?        @db.VarChar(160)
  canonicalUrl    String?

  // Media
  featuredImage    String?
  featuredImageAlt String?
  headerStyle      String         @default("gradient-green") // "image" | "gradient-green" | "gradient-yellow" | "gradient-coral" | "gradient-blue" | "gradient-teal" | "gradient-navy"

  // Publishing
  status          ArticleStatus  @default(DRAFT)
  publishedAt     DateTime?

  // Author
  authorId        String
  author          Author         @relation(fields: [authorId], references: [id])

  // Organisatie
  categoryId      String?
  category        Category?      @relation(fields: [categoryId], references: [id])
  tags            TagsOnArticles[]

  // Analytics
  viewCount       Int            @default(0)
  readingTime     Int?           // Minuten

  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relaties
  pageViews       PageView[]
  chatReferences  ChatMessageArticle[]
  researchSources ArticleResearchSource[]

  @@index([slug])
  @@index([status])
  @@index([categoryId])
  @@index([publishedAt])
  @@index([authorId])
}

enum ArticleStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
}

model Category {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?
  icon        String?   // Lucide icon naam
  color       String?   // Hex kleur
  sortOrder   Int       @default(0)

  // Parent categorie voor nesting
  parentId    String?
  parent      Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")

  articles    Article[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([slug])
  @@index([parentId])
}

model Tag {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique

  articles    TagsOnArticles[]

  createdAt   DateTime  @default(now())

  @@index([slug])
}

model TagsOnArticles {
  article     Article   @relation(fields: [articleId], references: [id], onDelete: Cascade)
  articleId   String
  tag         Tag       @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagId       String

  assignedAt  DateTime  @default(now())

  @@id([articleId, tagId])
}

model Author {
  id          String    @id @default(cuid())
  name        String
  email       String    @unique
  bio         String?   @db.Text
  avatar      String?
  role        String?   // "Founder", "Content Writer"

  // Link naar auth user
  userId      String?   @unique
  user        User?     @relation(fields: [userId], references: [id])

  articles    Article[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([email])
}

// ============================================
// AUTHENTICATIE & USERS (NextAuth.js)
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  role          UserRole  @default(VIEWER)

  // NextAuth
  emailVerified DateTime?
  accounts      Account[]
  sessions      Session[]

  // Relaties
  author        Author?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
}

enum UserRole {
  VIEWER
  WRITER
  EDITOR
  ADMIN
}

// NextAuth.js vereiste models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// AI CHAT SYSTEEM
// ============================================

model ChatSession {
  id            String        @id @default(cuid())
  visitorId     String        // Anonieme bezoeker identifier

  // Bezoeker tracking
  userAgent     String?
  referrer      String?
  landingPage   String?

  // Lead info (progressief verzameld)
  leadId        String?       @unique
  lead          Lead?         @relation(fields: [leadId], references: [id])

  // Session state
  isActive      Boolean       @default(true)
  lastMessageAt DateTime?
  messageCount  Int           @default(0)

  // Messages
  messages      ChatMessage[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([visitorId])
  @@index([createdAt])
  @@index([isActive])
}

model ChatMessage {
  id            String        @id @default(cuid())
  sessionId     String
  session       ChatSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  role          MessageRole
  content       String        @db.Text

  // Voor assistant messages
  tokensUsed    Int?
  modelUsed     String?

  // Artikel suggesties
  articleRefs   ChatMessageArticle[]

  createdAt     DateTime      @default(now())

  @@index([sessionId])
  @@index([createdAt])
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

// Many-to-many voor gesuggereerde artikelen in chat
model ChatMessageArticle {
  message       ChatMessage   @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId     String
  article       Article       @relation(fields: [articleId], references: [id], onDelete: Cascade)
  articleId     String

  relevanceScore Float?       // Semantic similarity score

  @@id([messageId, articleId])
}

model Lead {
  id            String        @id @default(cuid())

  // Contact info
  name          String?
  email         String?
  phone         String?
  organization  String?

  // Context
  source        LeadSource    @default(CHAT)
  interest      String?       // Waar ze interesse in hebben
  notes         String?       @db.Text

  // Status
  status        LeadStatus    @default(NEW)

  // Relaties
  chatSession   ChatSession?
  bookings      Booking[]
  quizResults   QuizResult[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([email])
  @@index([status])
  @@index([createdAt])
}

enum LeadSource {
  CHAT
  CONTACT_FORM
  NEWSLETTER
  DEMO_REQUEST
  QUIZ
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  ARCHIVED
}

// ============================================
// ANALYTICS
// ============================================

model PageView {
  id            String        @id @default(cuid())

  // Wat werd bekeken
  articleId     String?
  article       Article?      @relation(fields: [articleId], references: [id], onDelete: SetNull)
  path          String

  // Bezoeker
  visitorId     String
  sessionId     String?

  // Context
  referrer      String?
  userAgent     String?
  deviceType    DeviceType?

  // Engagement
  timeOnPage    Int?          // Seconden
  scrollDepth   Int?          // Percentage

  createdAt     DateTime      @default(now())

  @@index([articleId])
  @@index([path])
  @@index([createdAt])
  @@index([visitorId])
}

enum DeviceType {
  DESKTOP
  MOBILE
  TABLET
}

// ============================================
// SEARCH QUERIES TRACKING
// ============================================

model SearchQuery {
  id            String        @id @default(cuid())
  query         String
  resultsCount  Int           @default(0)
  visitorId     String?

  createdAt     DateTime      @default(now())

  @@index([query])
  @@index([createdAt])
}

// ============================================
// AFSPRAKEN SYSTEEM
// ============================================

model BookingType {
  id            String        @id @default(cuid())
  slug          String        @unique
  name          String
  description   String?
  duration      Int           // Minuten
  price         String?       // "Gratis", "€150", etc.
  color         String?       // Hex kleur voor kalender

  // Beschikbaarheid
  isActive      Boolean       @default(true)

  // Google Calendar
  calendarId    String?       // Specifieke calendar voor dit type

  bookings      Booking[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([slug])
  @@index([isActive])
}

model Booking {
  id            String        @id @default(cuid())

  // Type afspraak
  bookingTypeId String
  bookingType   BookingType   @relation(fields: [bookingTypeId], references: [id])

  // Wanneer
  startTime     DateTime
  endTime       DateTime
  timezone      String        @default("Europe/Amsterdam")

  // Wie
  name          String
  email         String
  phone         String?
  organization  String?

  // Context
  notes         String?       @db.Text
  source        BookingSource @default(WEBSITE)

  // Status
  status        BookingStatus @default(PENDING)

  // Google Calendar
  calendarEventId String?     // ID van event in Google Calendar
  meetingLink   String?       // Zoom/Meet link

  // Lead koppeling
  leadId        String?
  lead          Lead?         @relation(fields: [leadId], references: [id])

  // Email tracking
  confirmationSent Boolean    @default(false)
  reminderSent     Boolean    @default(false)

  // Cancellation
  cancelledAt   DateTime?
  cancelReason  String?

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([bookingTypeId])
  @@index([startTime])
  @@index([email])
  @@index([status])
  @@index([leadId])
}

enum BookingSource {
  WEBSITE
  CHAT
  PHONE
  EMAIL
  ADMIN
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

// Business hours configuratie
model BusinessHours {
  id            String        @id @default(cuid())
  dayOfWeek     Int           // 0=zondag, 1=maandag, etc.
  startTime     String        // "09:00"
  endTime       String        // "17:00"
  isActive      Boolean       @default(true)

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@unique([dayOfWeek])
}

// ============================================
// VRIJWILLIGERSCHECK QUIZ
// ============================================

model QuizResult {
  id            String        @id @default(cuid())

  // Scores
  totalScore    Int           // Totaal percentage (0-100)
  dimensionScores Json        // { beheer: 75, communicatie: 60, ... }
  answers       Json          // { "org-size": 2, "beheer-systeem": 3, ... }

  // Profiel
  profileId     String        // kampioen, gevorderd, groei, start

  // Context
  organizationSize String?    // xs, sm, md, lg
  volunteerCount   Int?

  // ROI berekening
  roiData       Json?         // { hoursSaved, costSaved, ... }

  // Bezoeker
  visitorId     String?

  // Lead koppeling
  leadId        String?
  lead          Lead?         @relation(fields: [leadId], references: [id])

  // PDF rapport
  pdfUrl        String?

  // Sharing
  shareToken    String        @unique @default(cuid())

  createdAt     DateTime      @default(now())

  @@index([visitorId])
  @@index([profileId])
  @@index([shareToken])
  @@index([createdAt])
}

// ============================================
// ONDERZOEK & RAG SYSTEEM
// ============================================

model ResearchSource {
  id            String              @id @default(cuid())

  // Identificatie
  title         String              // Titel van het onderzoek
  slug          String              @unique
  filename      String              // Originele bestandsnaam

  // Metadata
  authors       String?             // Auteurs/onderzoekers
  publisher     String?             // Uitgever/instituut
  publishYear   Int?                // Jaar van publicatie
  sourceUrl     String?             // Originele URL indien beschikbaar

  // Categorisatie
  category      ResearchCategory
  topics        String[]            // Array van onderwerpen

  // Content
  summary       String?             @db.Text  // AI-gegenereerde samenvatting
  keyFindings   Json?               // Array van belangrijkste bevindingen
  methodology   String?             // Onderzoeksmethode
  sampleSize    String?             // Steekproefgrootte

  // Processing status
  status        ResearchStatus      @default(PENDING)
  processedAt   DateTime?

  // Relaties
  chunks        KnowledgeChunk[]
  articles      ArticleResearchSource[]

  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@index([slug])
  @@index([category])
  @@index([status])
}

enum ResearchCategory {
  RETENTIE              // Vrijwilligersretentie & motivatie
  WERVING               // Werving & onboarding
  IMPACT                // Impact meten & rapportage
  TECHNOLOGIE           // AI/ML & digitalisering
  MANAGEMENT            // Organisatie & coördinatie
  WELZIJN               // Welzijn & waardering
  COMPLIANCE            // Juridisch & AVG
}

enum ResearchStatus {
  PENDING               // Nog niet verwerkt
  PROCESSING            // Wordt verwerkt
  COMPLETED             // Volledig verwerkt
  FAILED                // Verwerking mislukt
}

model KnowledgeChunk {
  id              String          @id @default(cuid())

  // Bron
  sourceId        String
  source          ResearchSource  @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  // Content
  content         String          @db.Text    // De tekst chunk
  contentType     ChunkType       @default(PARAGRAPH)

  // Positie in document
  pageNumber      Int?
  chunkIndex      Int             // Volgorde binnen document

  // Metadata voor retrieval
  topics          String[]        // Onderwerpen in deze chunk
  entities        String[]        // Genoemde entiteiten (organisaties, tools, etc.)

  // Vector embedding (stored as JSON, actual vector ops via raw SQL with pgvector)
  // Na pgvector extensie activeren: embedding Vector(1536)
  embeddingJson   Json?           // Tijdelijke opslag als JSON array

  // Kwaliteit & relevantie
  qualityScore    Float?          // AI-beoordeelde kwaliteit (0-1)
  isKeyInsight    Boolean         @default(false)  // Markering voor belangrijke inzichten

  createdAt       DateTime        @default(now())

  @@index([sourceId])
  @@index([contentType])
  @@index([isKeyInsight])
}

enum ChunkType {
  TITLE
  ABSTRACT
  HEADING
  PARAGRAPH
  BULLET_POINT
  STATISTIC       // Cijfers en statistieken
  QUOTE           // Citaten
  CONCLUSION
  RECOMMENDATION
}

// Koppeling tussen artikelen en onderzoeksbronnen
model ArticleResearchSource {
  article         Article         @relation(fields: [articleId], references: [id], onDelete: Cascade)
  articleId       String
  source          ResearchSource  @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  sourceId        String

  // Hoe is de bron gebruikt
  usageType       SourceUsageType @default(REFERENCE)
  citationText    String?         // Specifieke citatie indien van toepassing

  assignedAt      DateTime        @default(now())

  @@id([articleId, sourceId])
}

enum SourceUsageType {
  PRIMARY         // Hoofdbron voor artikel
  REFERENCE       // Ter ondersteuning geciteerd
  STATISTIC       // Statistiek overgenomen
  QUOTE           // Directe quote gebruikt
}
